const OFFICER_BTN="btn-outline-danger",SERGENT_BTN="btn-outline-info",SOILDER_BTN="btn-outline-secondary",CADET_BTN="btn-outline-success",BADGE_COLOR="bg-dark",RANKS=["#officer","#sergeant","#soilder","#cadet"],BTN_CLASS=[OFFICER_BTN,SERGENT_BTN,SOILDER_BTN,CADET_BTN],backend="https://baoge.fly.dev";$((function(){let e,t=[0,0,0,0],o={},a=!1,l=[],r=[],n=new Set,s=new Set,i=function(e){return MD5.generate(e).substr(16)};function c(e,t){e.addClass("active"),e.off("click"),e.click(t)}function d(e,t){e.removeClass("active"),e.off("click"),e.click(t)}function f(){if(0!==localStorage.length){if(!localStorage.hasOwnProperty("reasons")&&!localStorage.hasOwnProperty("members"))return console.log("No reasons and members. Clear localStorage"),void localStorage.clear();"reasons"in localStorage&&(l=JSON.parse(localStorage.getItem("reasons")));for(const e of l)g(localStorage.getItem(`r-${e}`,e));"members"in localStorage&&(r=JSON.parse(localStorage.getItem("members")));for(const e of r){let o=localStorage.getItem(`m-${e}`);if(!o)continue;let a=JSON.parse(o);if(!a.hasOwnProperty("key"))return console.log("No key. Clear localStorage"),void localStorage.clear();m(a.name,a.rank,a.key,a.reason),a.reason?$(`#${a.key}`).removeClass("active"):t[a.rank]++}k()}}function m(t,a,l="",r=""){l||(l=i(t));let n=$("<div></div>").attr({class:"col-auto",id:`div-${l}`}),s=`btn ${BTN_CLASS[a]} position-relative`;e||r||(s+=" active");let c=$(`<button>${t}</button>`).attr({type:"button",class:s,id:l});return e&&c.click(v),n.append(c),r&&u(c,r.slice(-1)),$(`${RANKS[a]}-list`).append(n),o[l]=a,l}function u(e,t){let o=`bge-${e.attr("id")}`,a=$(`#${o}`);if(a.length)a.html(t);else{let a=$(`<span>${t}</span>`).attr({class:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark",id:o});e.append(a),e.addClass("me-2")}}function h(e){e.removeClass("me-2"),$(`#bge-${e.attr("id")}`).remove()}function g(e,t=""){t||(t=i(e));let o=$("<div></div>").attr({class:"col-auto",id:`div-${t}`}),a=$(`<button>${e}</button>`).attr({type:"button",class:"btn btn-outline-primary",id:t,"data-bs-toggle":"button"});return a.click(b),o.append(a),$("#reason-list").append(o),t}function b(){if(a)s.add($(this).attr("id"));else{if(e){d($(`#${i(e)}`),b)}e=$(this).html();for(const t of r){let o=JSON.parse(localStorage.getItem(`m-${t}`)),a=$(`#${t}`);o.reason===e?c(a,N):o.reason!=e&&d(a,v)}}c($(this),S)}function S(){a?s.delete($(this).attr("id")):(e="",p()),d($(this),b)}function p(){for(const e of r){let t=$(`#${e}`);t.off("click"),JSON.parse(localStorage.getItem(`m-${e}`)).reason?t.removeClass("active"):t.addClass("active")}}function v(){let l=$(this);if(c(l,N),a)n.add(l.attr("id"));else{let a=`m-${l.attr("id")}`,r=JSON.parse(localStorage.getItem(a));if(!r.reason){let e=o[l.attr("id")];t[e]--,k(e)}u($(this),e.slice(-1)),r.reason=e,localStorage.setItem(a,JSON.stringify(r))}}function N(){let e=$(this);if(d(e,v),a)n.delete(e.attr("id"));else{let a=o[e.attr("id")];t[a]++,k(a);let l=`m-${$(this).attr("id")}`,r=JSON.parse(localStorage.getItem(l));h($(this)),r.reason="",localStorage.setItem(l,JSON.stringify(r))}}function k(e=-1){if(e<0)for(let e=0;e<t.length;e++)$(`${RANKS[e]}-num`).text(t[e]);else $(`${RANKS[e]}-num`).text(t[e]);$("#total-num").text(t.reduce(((e,t)=>e+t)))}f();let y=!1;function O(){y?($("#options-btn").html('<i class="bi bi-plus-circle"></i>'),$("#deletion-btn").css("opacity","1"),$("#deletion-btn").click(I)):($("#options-btn").html('<i class="bi bi-plus-circle-fill"></i>'),$("#deletion-btn").css("opacity","0.5"),$("#deletion-btn").off("click")),y=!y}function I(){a?($("#delete-div").hide(),$("#deletion-btn").html('<i class="bi bi-trash3"></i>'),$("#options-btn").css("opacity","1"),$("#options-btn").click(O),s.clear(),n.clear(),l.forEach((e=>{d($(`#${e}`),b)})),p()):($("#delete-div").show(),$("#deletion-btn").html('<i class="bi bi-trash3-fill"></i>'),$("#options-btn").css("opacity","0.5"),$("#options-btn").off("click"),l.forEach((e=>{d($(`#${e}`),b)})),r.forEach((e=>{d($(`#${e}`),v)}))),a=!a}$("#options-btn").click(O),$("#deletion-btn").click(I);let T=!1;function E(){for(const e of r)$(`#div-${e}`).remove();r=[],n.clear();for(const e of l)$(`#div-${e}`).remove();l=[],s.clear(),t.fill(0),k(),localStorage.clear()}$("#info-btn").click((function(){T?$("#info-btn").html('<i class="bi bi-info-circle"></i>'):$("#info-btn").html('<i class="bi bi-info-circle-fill"></i>'),T=!T})),$("#add-member-btn").click((function(){let e=$("#input-member").val();if(!e)return void alert("請輸入人員");let a=i(e);if(a in o)return void alert("人員重複了");let l=parseInt($("#input-class option:selected").val());l<0?alert("請選擇階級"):(m(e,l,a),localStorage.setItem(`m-${a}`,JSON.stringify({name:e,rank:l,selected:!1,key:a})),$("#input-member").val(""),t[l]++,k(),r.push(a),localStorage.setItem("members",JSON.stringify(r)))})),$("#add-reason-btn").click((function(){let e=$("#input-reason").val();if($("#input-reason").val(""),!e)return void alert("請輸入事故");let t=i(e);`r-${t}`in localStorage?alert("事故重複了"):(g(e,t),l.push(t),localStorage.setItem(`r-${t}`,e),localStorage.setItem("reasons",JSON.stringify(l)))})),$("#delete-selection-btn").click((function(){!function(){let e=[];r.forEach((t=>{n.has(t)||e.push(t)})),r=Array.from(e),localStorage.setItem("members",JSON.stringify(r)),n.forEach((e=>{let a=JSON.parse(localStorage.getItem(`m-${e}`));a.reason||t[a.rank]--,$(`#div-${e}`).remove(),delete o[e],localStorage.removeItem(`m-${e}`)})),n.clear(),k()}(),function(){let e=[];l.forEach((t=>{s.has(t)||e.push(t)})),l=Array.from(e),localStorage.setItem("reasons",JSON.stringify(l)),r.forEach((e=>{let o=JSON.parse(localStorage.getItem(`m-${e}`));o.reason&&s.has(i(o.reason))&&(o.reason="",h($(`#${e}`)),localStorage.setItem(`m-${e}`,JSON.stringify(o)),t[o.rank]++)})),s.forEach((e=>{$(`#div-${e}`).remove(),localStorage.removeItem(`r-${e}`)})),s.clear(),k()}(),l.forEach((e=>{d($(`#${e}`),b)})),r.forEach((e=>{d($(`#${e}`),v)}))})),$("#delete-all-btn").click(E),$("#share-btn").click((function(){$("#share-result").html('<div class="spinner-border" role="status"></div>')})),$("#gen-share-code-btn").click((function(){0!==localStorage.length&&(localStorage.hasOwnProperty("reasons")||localStorage.hasOwnProperty("members"))?$.ajax({url:`${backend}/share`,method:"POST",contentType:"application/json; charset=UTF-8",dataType:"json",data:JSON.stringify(localStorage),timeout:1e4,success:function(e){$("#share-result").html(`<h1 class="text-success" style="font-size:3rem">${e.code}</h1>`)},error:function(e){$("#share-result").html('<h3 class="text-danger">分享失敗QQ</h3>'),console.log(e)}}):$("#share-result").html('<h1 class="text-danger">資料不足</h1>')})),$("#retrieve-btn").click((function(){let e=parseInt($("#input-share-code").val());$("#input-share-code").val(""),$.ajax({url:`${backend}/retrieve`,method:"POST",contentType:"application/json; charset=UTF-8",dataType:"json",data:JSON.stringify({code:e}),timeout:1e4,success:function(e){E();for(let t in e)localStorage.setItem(t,e[t]);f(),$("#share-result").html('<h1 class="text-success">擷取成功</h1>'),$("#share-dialogue-2").modal("hide")},error:function(e){$("#share-result").html('<h1 class="text-danger">代碼無效</h1>'),console.log(e)}})}))}));