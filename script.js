const OFFICER_BTN="btn-outline-danger",SERGENT_BTN="btn-outline-info",SOILDER_BTN="btn-outline-secondary",CADET_BTN="btn-outline-success",BADGE_COLOR="bg-dark",RANKS=["#officer","#sergeant","#soilder","#cadet"],BTN_CLASS=[OFFICER_BTN,SERGENT_BTN,SOILDER_BTN,CADET_BTN],backend="https://baoge.fly.dev";$((function(){let t,e=[0,0,0,0],a={},o=!1,l=[],n=[],r=new Set,s=new Set,i=function(t){return MD5.generate(t).substring(16)};function c(t,e){t.addClass("active"),t.off("click"),t.click(e)}function d(t,e){t.removeClass("active"),t.off("click"),t.click(e)}function f(){if(0!==localStorage.length){if(!localStorage.hasOwnProperty("reasons")&&!localStorage.hasOwnProperty("members"))return console.log("No reasons and members. Clear localStorage"),void localStorage.clear();"reasons"in localStorage&&(l=JSON.parse(localStorage.getItem("reasons")));for(const t of l)h(localStorage.getItem(`r-${t}`,t));"members"in localStorage&&(n=JSON.parse(localStorage.getItem("members")));for(const t of n){let a=localStorage.getItem(`m-${t}`);if(!a)continue;let o=JSON.parse(a);if(!o.hasOwnProperty("key"))return console.log("No key. Clear localStorage"),void localStorage.clear();m(o.name,o.rank,o.key,o.reason),o.reason?$(`#${o.key}`).removeClass("active"):e[o.rank]++}k()}}function m(e,o,l="",n=""){l||(l=i(e));let r=$("<div></div>").attr({class:"col-auto",id:`div-${l}`}),s=`btn ${BTN_CLASS[o]} position-relative`;t||n||(s+=" active");let c=$(`<button>${e}</button>`).attr({type:"button",class:s,id:l});return t&&c.click(v),r.append(c),n&&u(c,n.slice(-1)),$(`${RANKS[o]}-list`).append(r),a[l]=o,l}function u(t,e){let a=`bge-${t.attr("id")}`,o=$(`#${a}`);if(o.length)o.html(e);else{let o=$(`<span>${e}</span>`).attr({class:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark",id:a});t.append(o),t.addClass("me-2")}}function g(t){t.removeClass("me-2"),$(`#bge-${t.attr("id")}`).remove()}function h(t,e=""){e||(e=i(t));let a=$("<div></div>").attr({class:"col-auto",id:`div-${e}`}),o=$(`<button>${t}</button>`).attr({type:"button",class:"btn btn-outline-primary",id:e,"data-bs-toggle":"button"});return o.click(b),a.append(o),$("#reason-list").append(a),e}function b(){if(o)s.add($(this).attr("id"));else{if(t){d($(`#${i(t)}`),b)}t=$(this).html();for(const e of n){let a=JSON.parse(localStorage.getItem(`m-${e}`)),o=$(`#${e}`);a.reason===t?c(o,N):a.reason!=t&&d(o,v)}}c($(this),p)}function p(){o?s.delete($(this).attr("id")):(t="",S()),d($(this),b)}function S(){for(const t of n){let e=$(`#${t}`);e.off("click"),JSON.parse(localStorage.getItem(`m-${t}`)).reason?e.removeClass("active"):e.addClass("active")}}function v(){let l=$(this);if(c(l,N),o)r.add(l.attr("id"));else{let o=`m-${l.attr("id")}`,n=JSON.parse(localStorage.getItem(o));if(!n.reason){let t=a[l.attr("id")];e[t]--,k(t)}u($(this),t.slice(-1)),n.reason=t,localStorage.setItem(o,JSON.stringify(n))}}function N(){let t=$(this);if(d(t,v),o)r.delete(t.attr("id"));else{let o=a[t.attr("id")];e[o]++,k(o);let l=`m-${$(this).attr("id")}`,n=JSON.parse(localStorage.getItem(l));g($(this)),n.reason="",localStorage.setItem(l,JSON.stringify(n))}}function k(t=-1){if(t<0)for(let t=0;t<e.length;t++)$(`${RANKS[t]}-num`).text(e[t]);else $(`${RANKS[t]}-num`).text(e[t]);$("#total-num").text(e.reduce(((t,e)=>t+e)))}f();let y=!1;function O(){y?($("#options-btn").html('<i class="bi bi-plus-circle"></i>'),$("#deletion-btn").css("opacity","1"),$("#deletion-btn").click(I)):($("#options-btn").html('<i class="bi bi-plus-circle-fill"></i>'),$("#deletion-btn").css("opacity","0.5"),$("#deletion-btn").off("click")),y=!y}function I(){o?($("#delete-div").hide(),$("#deletion-btn").html('<i class="bi bi-trash3"></i>'),$("#options-btn").css("opacity","1"),$("#options-btn").click(O),$("#options-btn").attr("data-bs-target","#add-new-div"),s.clear(),r.clear(),l.forEach((t=>{d($(`#${t}`),b)})),S()):($("#delete-div").show(),$("#deletion-btn").html('<i class="bi bi-trash3-fill"></i>'),$("#options-btn").css("opacity","0.5"),$("#options-btn").off("click"),$("#options-btn").attr("data-bs-target",""),l.forEach((t=>{d($(`#${t}`),b)})),n.forEach((t=>{d($(`#${t}`),v)}))),o=!o}$("#options-btn").click(O),$("#deletion-btn").click(I);let T=!1;function E(){for(const t of n)$(`#div-${t}`).remove();n=[],r.clear();for(const t of l)$(`#div-${t}`).remove();l=[],s.clear(),e.fill(0),k(),localStorage.clear()}$("#info-btn").click((function(){T?$("#info-btn").html('<i class="bi bi-info-circle"></i>'):$("#info-btn").html('<i class="bi bi-info-circle-fill"></i>'),T=!T})),$("#add-member-btn").click((function(){let t=$("#input-member").val();if(!t)return void alert("請輸入人員");let o=i(t);if(o in a)return void alert("人員重複了");let l=parseInt($("#input-class option:selected").val());l<0?alert("請選擇階級"):(m(t,l,o),localStorage.setItem(`m-${o}`,JSON.stringify({name:t,rank:l,selected:!1,key:o})),$("#input-member").val(""),e[l]++,k(),n.push(o),localStorage.setItem("members",JSON.stringify(n)))})),$("#add-reason-btn").click((function(){let t=$("#input-reason").val();if($("#input-reason").val(""),!t)return void alert("請輸入事故");let e=i(t);`r-${e}`in localStorage?alert("事故重複了"):(h(t,e),l.push(e),localStorage.setItem(`r-${e}`,t),localStorage.setItem("reasons",JSON.stringify(l)))})),$("#delete-selection-btn").click((function(){!function(){let t=[];n.forEach((e=>{r.has(e)||t.push(e)})),n=Array.from(t),localStorage.setItem("members",JSON.stringify(n)),r.forEach((t=>{let o=JSON.parse(localStorage.getItem(`m-${t}`));o.reason||e[o.rank]--,$(`#div-${t}`).remove(),delete a[t],localStorage.removeItem(`m-${t}`)})),r.clear(),k()}(),function(){let t=[];l.forEach((e=>{s.has(e)||t.push(e)})),l=Array.from(t),localStorage.setItem("reasons",JSON.stringify(l)),n.forEach((t=>{let a=JSON.parse(localStorage.getItem(`m-${t}`));a.reason&&s.has(i(a.reason))&&(a.reason="",g($(`#${t}`)),localStorage.setItem(`m-${t}`,JSON.stringify(a)),e[a.rank]++)})),s.forEach((t=>{$(`#div-${t}`).remove(),localStorage.removeItem(`r-${t}`)})),s.clear(),k()}(),l.forEach((t=>{d($(`#${t}`),b)})),n.forEach((t=>{d($(`#${t}`),v)}))})),$("#delete-all-btn").click(E),$("#share-btn").click((function(){$("#share-result").html('<div class="spinner-border" role="status"></div>')})),$("#gen-share-code-btn").click((function(){0!==localStorage.length&&(localStorage.hasOwnProperty("reasons")||localStorage.hasOwnProperty("members"))?$.ajax({url:`${backend}/share`,method:"POST",contentType:"application/json; charset=UTF-8",dataType:"json",data:JSON.stringify(localStorage),timeout:1e4,success:function(t){$("#share-result").html(`<h1 class="text-success" style="font-size:3rem">${t.code}</h1>`)},error:function(t){$("#share-result").html('<h3 class="text-danger">分享失敗QQ</h3>'),console.log(t)}}):$("#share-result").html('<h1 class="text-danger">資料不足</h1>')})),$("#retrieve-btn").click((function(){let t=parseInt($("#input-share-code").val());$("#input-share-code").val(""),$.ajax({url:`${backend}/retrieve`,method:"POST",contentType:"application/json; charset=UTF-8",dataType:"json",data:JSON.stringify({code:t}),timeout:1e4,success:function(t){E();for(let e in t)localStorage.setItem(e,t[e]);f(),$("#share-result").html('<h1 class="text-success">擷取成功</h1>'),$("#share-dialogue-2").modal("hide")},error:function(t){$("#share-result").html('<h1 class="text-danger">代碼無效</h1>'),console.log(t)}})}))}));